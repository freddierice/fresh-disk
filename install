#!/bin/bash

# sourcing
. ./utils

user_sure

echo "WARNING: each of these locations will be wiped and data recovery"
echo "will be very difficult: "
echo "  key   $KEY_DEV"
echo "  boot  $BOOT_DEV"
echo "  root  $ROOT_DEV"
echo "do you want to overwrite each of these locations? (YES/no): "
read resp

if [ "x$resp" != "xYES" ]; then
    exit 1
fi

# check for programs used in the script
check_bins pv cryptsetup openssl xxd blockdev grub-mkconfig yes parted \
           dd sync umount mount mkfs.ext2 grep

# sanity checks
check_root
check_device "$ROOT_DEV"
check_device "$BOOT_DEV"

check_debian_ready

# make sure the key is a full disk
echo $KEY_DEV | grep -q "[0-9]"
if [ $? == 0 ]; then
    echo "key device $KEY_DEV is a partition: expected full disk."
    exit 1
fi

echo "removing all disks from use"
umount_all "$KEY_DEV" && umount_all "$ROOT_DEV" && umount_all "$BOOT_DEV"
if [ $? != 0 ]; then
    echo "could not unmount the disks from the filesystem. to avoid unexpected"
    echo "errors, unmount them before running this script."
    exit 1
fi

echo "formatting $KEY_DEV to msdos, one partition"
dd if=/dev/zero bs=512 count=1 of="$KEY_DEV"
yes | parted "$KEY_DEV" mklabel msdos
yes | parted "$KEY_DEV" unit "%" mkpart primary ext2 0 100

echo "overwriting $ROOT_DEV with random data"
overwrite_device "$ROOT_DEV" "$ROOT_DEV_SIZE"

echo "overwriting $BOOT_DEV with random data"
overwrite_device "$BOOT_DEV" "$BOOT_DEV_SIZE"

echo "creating a random key"
mntdir="$(mktemp -d)"
mount -t ext2 $KEY_DEV "$mntdir"
if [ -e "$mntdir/key" ]; then
    rm -f "$mntdir/key"
fi
dd if=/dev/urandom bs=$KEY_SIZE count=1 of="$mntdir/key"
sync 

echo "creating an encrypted volume on $ROOT_DEV"
cryptsetup luksFormat --hash=$HASH_SPEC --cipher=$CIPHER_SPEC --iter-time=$ITER_TIME "$ROOT_DEV" "$mntdir/key"
if [ "$?" != "0" ]; then
    echo "error while running cryptsetup luksFormat."
    exit 1
fi
freshdisk=/dev/mapper/freshdisk
while [ -e $freshdisk ]; do
    let "l=$RANDOM%10" 
    freshdisk="$freshdisk$l"
done
cryptsetup luksOpen "$ROOT_DEV" "$freshdisk" --key-file "$mntdir/key"
umount "$mntdir"
mkfs.ext4 "$freshdisk"
mount "$freshdisk" "$mntdir"

echo "installing debian"
# TODO: install debian

# done
cryptsetup luksClose "freshdisk"
